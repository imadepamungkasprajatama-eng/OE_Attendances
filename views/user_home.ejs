<%- include('partials/header',{user:user, title:'Home', isWorking: (attendanceSummary.status==='working' )}) %>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 bg-white" style="border-radius: 1.5rem;">
        <div class="card-body p-4 p-lg-5 d-flex align-items-center justify-content-between flex-wrap">
          <div>
            <h2 class="fw-bold mb-1">Hi, <%= user.name.split(' ')[0] %>! üëã</h2>
          <p class="text-muted mb-0">Here' s what's happening today.</p>
          </div>
          <div class="mt-3 mt-md-0 text-end">
            <p class="small text-uppercase text-muted fw-bold mb-1">
              <%= attendanceSummary.dateLabel %>
            </p>
            <div class="d-inline-flex align-items-center px-3 py-1 rounded-pill bg-soft border">
              <span
                class="badge bg-<%= attendanceSummary.status === 'working' ? 'success' : (attendanceSummary.status === 'break' ? 'warning' : 'secondary') %> rounded-pill me-2">‚óè</span>
              <span class="fw-semibold small" id="status-label-top">
                <%= attendanceSummary.status==='working' ? 'Working' : (attendanceSummary.status==='break' ? 'On Break'
                  : 'Idle' ) %>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Left Column: Actions & Timer -->
    <div class="col-lg-8">
      <!-- QR Scanner Section (Modal Trigger) -->
      <div class="card mb-4 border-0 shadow-sm" style="border-radius: 1rem;">
        <div class="card-body p-4 d-flex align-items-center justify-content-between">
          <div>
            <h5 class="fw-bold mb-1">Scan QR Code</h5>
            <p class="text-muted small mb-0">Use this to Check In/Out or Break</p>
          </div>
          <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#qrScannerModal"
            onclick="startQRScanner()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="feather feather-camera me-2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
              <circle cx="12" cy="13" r="4"></circle>
            </svg>
            Scan Camera
          </button>
        </div>
      </div>

      <!-- QR Scanner Modal -->
      <div class="modal fade" id="qrScannerModal" tabindex="-1" aria-labelledby="qrScannerModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0" style="border-radius: 1.5rem;">
            <div class="modal-header border-0">
              <h5 class="modal-title fw-bold" id="qrScannerModalLabel">Scan QR Code</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                onclick="stopQRScanner()"></button>
            </div>
            <div class="modal-body p-0 position-relative bg-black"
              style="min-height: 300px; overflow: hidden; border-bottom-left-radius: 1.5rem; border-bottom-right-radius: 1.5rem;">
              <!-- The ID 'qr-result' currently holds the text status, but often the video is appended to a container. 
                   We will use a dedicated container for the video to avoid conflicts. -->
              <div id="qr-reader-container" class="w-100 h-100 d-flex align-items-center justify-content-center">
                <!-- Video will be appended here by JS -->
              </div>

              <!-- Overlay for status text -->
              <div id="qr-result"
                class="position-absolute bottom-0 w-100 text-center text-white p-2 bg-dark bg-opacity-75 small">
                Camera starting...
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Actions Grid -->
      <div class="row g-3">
        <div class="col-md-6">
          <button id="btn-check-in"
            class="btn btn-primary w-100 p-4 h-100 d-flex flex-column align-items-start justify-content-between"
            onclick="doAction('check-in')" disabled style="border-radius: 1.25rem;">
            <div class="mb-2 opacity-75"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                <polyline points="10 17 15 12 10 7"></polyline>
                <line x1="15" y1="12" x2="3" y2="12"></line>
              </svg></div>
            <div class="fw-bold fs-5">Check In</div>
            <div class="small opacity-75">Start your workday</div>
          </button>
        </div>
        <div class="col-md-6">
          <button id="btn-check-out"
            class="btn btn-danger w-100 p-4 h-100 d-flex flex-column align-items-start justify-content-between"
            onclick="doAction('check-out')" disabled style="border-radius: 1.25rem;">
            <div class="mb-2 opacity-75"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg></div>
            <div class="fw-bold fs-5">Check Out</div>
            <div class="small opacity-75">End your workday</div>
          </button>
        </div>
        <div class="col-md-6">
          <button id="btn-break-start"
            class="btn btn-warning w-100 p-4 h-100 d-flex flex-column align-items-start justify-content-between text-dark"
            onclick="doAction('break-start')" disabled style="border-radius: 1.25rem;">
            <div class="mb-2 opacity-75"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg></div>
            <div class="fw-bold fs-5">Start Break</div>
            <div class="small opacity-75">Take a rest</div>
          </button>
        </div>
        <div class="col-md-6">
          <button id="btn-break-end"
            class="btn btn-secondary w-100 p-4 h-100 d-flex flex-column align-items-start justify-content-between"
            onclick="doAction('break-end')" disabled style="border-radius: 1.25rem;">
            <div class="mb-2 opacity-75"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polygon points="10 8 16 12 10 16 10 8"></polygon>
              </svg></div>
            <div class="fw-bold fs-5">End Break</div>
            <div class="small opacity-75">Back to work</div>
          </button>
        </div>
      </div>
    </div>

    <!-- Right Column: Stats -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-4">Today's Stats</h5>

          <div class="mb-4">
            <label class="small text-muted fw-bold text-uppercase">Work Timer</label>
            <div class="d-flex align-items-baseline">
              <h1 class="fw-bold mb-0 text-primary" id="work-live">00:00:00</h1>
            </div>
            <div class="small text-muted">Total: <span id="work-total">
                <%= attendanceSummary.workText %>
              </span></div>
          </div>

          <div class="mb-4">
            <label class="small text-muted fw-bold text-uppercase">Break Timer</label>
            <div class="d-flex align-items-baseline">
              <h3 class="fw-bold mb-0 text-warning" id="break-live" style="font-family: monospace">00:00:00</h3>
            </div>
            <div class="small text-muted">Total: <span id="break-total">
                <%= attendanceSummary.breakText %>
              </span></div>
          </div>

          <hr class="my-4 opacity-10">

          <% if (attendanceSummary.workIntervals && attendanceSummary.workIntervals.length) { %>
            <h6 class="fw-bold small mb-2">Work Sessions</h6>
            <ul class="list-unstyled mb-4 small ps-2 border-start border-primary border-2">
              <% attendanceSummary.workIntervals.forEach(function(w){ %>
                <li class="mb-1 text-muted ms-2">
                  <%= w.start %> - <%= w.end %>
                </li>
                <% }) %>
            </ul>
            <% } %>

              <% if (attendanceSummary.breakIntervals && attendanceSummary.breakIntervals.length) { %>
                <h6 class="fw-bold small mb-2">Break Sessions</h6>
                <ul class="list-unstyled small ps-2 border-start border-warning border-2">
                  <% attendanceSummary.breakIntervals.forEach(function(b){ %>
                    <li class="mb-1 text-muted ms-2">
                      <%= w.start %> - <%= w.end %>
                    </li>
                    <% }) %>
                </ul>
                <% } %>

        </div>
      </div>
    </div>
  </div>

  <% if ( user.role==='Supervisor' || user.role==='Operational Manager' || user.role==='General Manager' ||
    user.canAccessSupervisorDashboard ) { %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="fw-bold mb-0">Team: <%= user.division || '-' %>
              </h5>
              <a href="/supervisor" class="btn btn-outline-primary btn-sm rounded-pill px-4">View Dashboard</a>
            </div>
            <% if (divisionMembers && divisionMembers.length) { %>
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="bg-light text-muted small text-uppercase">
                    <tr>
                      <th class="border-0 rounded-start ps-3">Name</th>
                      <th class="border-0">Email</th>
                      <th class="border-0 rounded-end pe-3">Role</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% divisionMembers.forEach(function(m){ %>
                      <tr>
                        <td class="ps-3 fw-medium">
                          <%= m.name %>
                        </td>
                        <td class="text-muted">
                          <%= m.email %>
                        </td>
                        <td class="pe-3"><span class="badge bg-soft text-dark border">
                            <%= m.role %>
                          </span></td>
                      </tr>
                      <% }) %>
                  </tbody>
                </table>
              </div>
              <% } else { %>
                <p class="text-muted mb-0">No team members found.</p>
                <% } %>
          </div>
        </div>
      </div>
    </div>
    <% } %>

      <script src="/public/js/attendance.js"></script>

      <script>
        // Inject server-side config to window for client logic
        window.OFFICE_CONFIG = {
          lat: <%= office.lat %>,
          lng: <%= office.lng %>,
          radius: <%= office.radius %>
        };
        window.USER_STATUS = '<%= attendanceSummary.status %>';

        async function doAction(act) {
          const qr = window.getCurrentQR();
          if (!qr) {
            if (!confirm('No scanned QR token found. Use server preview token?')) return;
          }
          const token = qr || '<%= token.token %>';
          await window.doGeolocatedAction(act, token);
        }
      </script>

      <!-- ==== LIVE TIMER SCRIPT START ==== -->
      <script>
        (function () {
          // data dari server
          const status = "<%= attendanceSummary.status %>";
          const baseWorkSeconds = Number("<%= attendanceSummary.baseWorkSeconds || 0 %>");
          const baseBreakSeconds = Number("<%= attendanceSummary.baseBreakSeconds || 0 %>");
          const currentWorkStart = "<%= attendanceSummary.currentWorkStart != null ? attendanceSummary.currentWorkStart : '' %>";
          const currentBreakStart = "<%= attendanceSummary.currentBreakStart != null ? attendanceSummary.currentBreakStart : '' %>";

          const workStartMs = currentWorkStart ? Number(currentWorkStart) : null;
          const breakStartMs = currentBreakStart ? Number(currentBreakStart) : null;

          const workTotalEl = document.getElementById('work-total');
          const breakTotalEl = document.getElementById('break-total');
          const workLiveEl = document.getElementById('work-live');
          const breakLiveEl = document.getElementById('break-live');
          const statusLabel = document.getElementById('status-label');

          function formatDuration(sec) {
            sec = Math.floor(sec);
            if (sec < 0) sec = 0;
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            const pad = n => n.toString().padStart(2, '0');
            return pad(h) + ':' + pad(m) + ':' + pad(s);
          }

          function updateStatusLabel() {
            if (!statusLabel) return;
            if (status === 'working') statusLabel.textContent = 'Sedang bekerja';
            else if (status === 'break') statusLabel.textContent = 'Sedang break';
            else statusLabel.textContent = 'Idle';
          }

          function tick() {
            const nowMs = Date.now();

            let workTotalSec = baseWorkSeconds;
            let breakTotalSec = baseBreakSeconds;

            // Hitung sesi kerja yang masih berjalan
            if (status === 'working' && workStartMs) {
              const sessionSec = (nowMs - workStartMs) / 1000;
              workTotalSec += sessionSec;
              if (workLiveEl) workLiveEl.textContent = formatDuration(sessionSec);
            } else {
              if (workLiveEl) workLiveEl.textContent = "00:00:00";
            }

            // Hitung sesi break yang masih berjalan
            if (status === 'break' && breakStartMs) {
              const sessionSec = (nowMs - breakStartMs) / 1000;
              breakTotalSec += sessionSec;
              if (breakLiveEl) breakLiveEl.textContent = formatDuration(sessionSec);
            } else {
              if (breakLiveEl) breakLiveEl.textContent = "00:00:00";
            }

            // Update total harian
            if (workTotalEl) workTotalEl.textContent = formatDuration(workTotalSec);
            if (breakTotalEl) breakTotalEl.textContent = formatDuration(breakTotalSec);
          }

          updateStatusLabel();
          tick();
          setInterval(tick, 1000);
        })();
      </script>
      <!-- ==== LIVE TIMER SCRIPT END ==== -->

      <%- include('partials/footer') %>